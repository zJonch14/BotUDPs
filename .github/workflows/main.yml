name: ðŸš€ Bot UDPs

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  deploy-bot-continuous:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Usar cÃ³digo actual
      uses: actions/checkout@v4
    
    - name: ðŸ Configurar Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ðŸ¦¾ Configurar Go 1.21
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
    
    - name: ðŸ”§ Instalar herramientas de compilaciÃ³n
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential gcc g++ make libpcap-dev
    
    - name: ðŸ“¦ Instalar discord.py
      run: |
        python -m pip install --upgrade pip
        pip install discord.py
    
    - name: ðŸ“š Configurar Go modules
      run: |
        if [ ! -f "go.mod" ]; then
          go mod init bot-udps 2>/dev/null || true
        fi
        go get github.com/sandertv/go-raknet 2>/dev/null || true
    
    - name: ðŸ› ï¸ Compilar binarios C
      run: |
        echo "=== COMPILANDO BINARIOS ==="
        
        # Compilar todos los .c que existan
        for c_file in *.c; do
          if [ -f "$c_file" ]; then
            binary="${c_file%.c}"
            echo "Compilando $c_file â†’ $binary"
            gcc -O3 -pthread "$c_file" -o "$binary" 2>/dev/null || echo "  Error con $c_file"
            
            if [ -f "$binary" ]; then
              chmod +x "$binary"
              echo "  âœ“ $binary listo"
            fi
          fi
        done
        
        echo "Binarios disponibles:"
        find . -maxdepth 1 -type f -executable ! -name "*.py" ! -name "*.go" | xargs -I {} basename {} 2>/dev/null || echo "Ninguno"
    
    - name: ðŸ” Configurar token desde secret KEYS
      env:
        DISCORD_TOKEN: ${{ secrets.KEYS }}
      run: |
        if [ -z "$DISCORD_TOKEN" ]; then
          echo "ERROR: Secret 'KEYS' no configurado"
          echo "ConfigÃºralo en: Settings â†’ Secrets â†’ Actions â†’ KEYS"
          exit 1
        fi
        
        echo "$DISCORD_TOKEN" > token.txt
        echo "Token guardado en token.txt ($(wc -c < token.txt) caracteres)"
    
    - name: ðŸš€ Ejecutar bot CONTINUAMENTE
      run: |
        echo "========================================"
        echo "INICIANDO BOT EN MODO CONTINUO"
        echo "========================================"
        echo "El bot se ejecutarÃ¡ hasta que:"
        echo "1. GitHub detenga el runner (â‰ˆ6 horas)"
        echo "2. Ocurra un error crÃ­tico"
        echo "3. Se cancele manualmente"
        echo "========================================"
        echo ""
        echo "MÃ‰TODOS DISPONIBLES:"
        echo "!attack udp [ip] [puerto] [tiempo]"
        echo "!attack udphex [ip] [puerto] [tiempo]"
        echo "!attack udppps [ip] [puerto] [tiempo]"
        echo "!attack ovh [ip] [puerto] [tiempo]"
        echo "!attack raknet [ip] [puerto] [tiempo]"
        echo "!attack udpflood [ip] [puerto] [tiempo]"
        echo "!attack udppayload [ip] [puerto] [tiempo] [payload]"
        echo ""
        echo "âš ï¸  MODO SIGILOSO: 0 mensajes en Discord"
        echo "ðŸ“ Logs solo en esta consola"
        echo "========================================"
        
        # Verificar archivos esenciales
        if [ ! -f "bot.py" ]; then
          echo "ERROR: bot.py no encontrado"
          exit 1
        fi
        
        if [ ! -f "token.txt" ] || [ ! -s "token.txt" ]; then
          echo "ERROR: token.txt no vÃ¡lido"
          exit 1
        fi
        
        echo ""
        echo "âœ… INICIANDO EJECUCIÃ“N CONTINUA..."
        echo "Hora de inicio: $(date)"
        echo "El bot permanecerÃ¡ activo hasta que GitHub lo detenga."
        echo ""
        
        # Ejecutar bot INDEFINIDAMENTE (sin timeout)
        python3 bot.py
        
        # Esto solo se ejecutarÃ¡ si el bot se detiene por error
        echo ""
        echo "========================================"
        echo "BOT DETENIDO"
        echo "Hora de finalizaciÃ³n: $(date)"
        echo "CÃ³digo de salida: $?"
        echo "========================================"
